<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Integrazione Firme SMIRT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .signature-canvas {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            cursor: crosshair;
        }
        .signature-canvas:hover {
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">üß™ Test Integrazione Firme SMIRT</h1>
            
            <!-- Configurazione -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <h2 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Setup Richiesto</h2>
                <ol class="text-sm text-yellow-700 space-y-1">
                    <li>1. Aggiorna <code>APPS_SCRIPT_URL</code> in <code>js/signatures.js</code></li>
                    <li>2. Deploy del Google Apps Script come Web App</li>
                    <li>3. Permessi "Anyone, even anonymous" nel GAS</li>
                    <li>4. Verifica ID cartella Drive: <code>13vI7aODCn6CT4soLk73Ki5FxRptttS74</code></li>
                </ol>
            </div>

            <!-- Test Connessione -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-3">üîó Test Connessione</h2>
                <button id="testBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    Test Google Apps Script
                </button>
                <div id="testResult" class="mt-3 p-3 rounded-lg hidden"></div>
            </div>

            <!-- Simulazione Rapporto -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-3">üìù Dati Rapporto Test</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">MUD</label>
                        <input type="text" id="mudInput" class="w-full p-2 border rounded-lg" 
                               value="TEST-MUD-${Date.now()}" placeholder="Codice MUD">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Utente</label>
                        <input type="text" id="userInput" class="w-full p-2 border rounded-lg" 
                               value="admin" placeholder="Nome utente">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Luogo</label>
                        <input type="text" id="luogoInput" class="w-full p-2 border rounded-lg" 
                               value="Milano - Test Location" placeholder="Luogo intervento">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Riferimento</label>
                        <input type="text" id="riferimentoInput" class="w-full p-2 border rounded-lg" 
                               value="RIF-TEST-001" placeholder="Codice riferimento">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label>
                        <input type="date" id="dataInizioInput" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Fine</label>
                        <input type="date" id="dataFineInput" class="w-full p-2 border rounded-lg">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="descrizioneInput" class="w-full p-2 border rounded-lg" rows="3"
                              placeholder="Descrizione intervento...">Test integrazione sistema firme con Google Drive cartella specifica</textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Materiali</label>
                    <textarea id="materialiInput" class="w-full p-2 border rounded-lg" rows="2"
                              placeholder="Materiali utilizzati...">Materiali test per verifica upload</textarea>
                </div>
            </div>

            <!-- Firma -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-3">‚úçÔ∏è Firma Committente</h2>
                <div class="flex flex-col items-center">
                    <canvas id="signatureCanvas" class="signature-canvas bg-white" 
                            width="400" height="200"></canvas>
                    <div class="mt-3 space-x-2">
                        <button id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            Cancella
                        </button>
                        <button id="testSignatureBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">
                            Genera Firma Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Azioni Test -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-3">üöÄ Test Operazioni</h2>
                <div class="space-x-2 space-y-2">
                    <button id="saveDataBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        1. Salva Solo Dati
                    </button>
                    <button id="uploadSignatureBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">
                        2. Upload Solo Firma
                    </button>
                    <button id="completeWorkflowBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        3. Workflow Completo
                    </button>
                    <button id="cleanupBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                        üßπ Pulizia Cartelle
                    </button>
                </div>
            </div>

            <!-- Risultati -->
            <div id="results" class="space-y-3">
                <h2 class="text-lg font-semibold">üìä Risultati Test</h2>
                <div id="resultContainer" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Include client signatures -->
    <script src="js/signatures.js"></script>
    
    <script>
        // Inizializza date di oggi
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dataInizioInput').value = today;
        document.getElementById('dataFineInput').value = today;
        
        // Genera MUD univoco
        document.getElementById('mudInput').value = 'TEST-MUD-' + Date.now();

        // Canvas per firma
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        // Eventi canvas
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events per mobile
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        // Clear canvas
        document.getElementById('clearBtn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            addResult('info', 'üóëÔ∏è Canvas pulito');
        });

        // Genera firma test
        document.getElementById('testSignatureBtn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Disegna firma test
            ctx.font = '24px Arial';
            ctx.fillStyle = '#000';
            ctx.fillText('Firma Test', 20, 50);
            
            ctx.font = '16px Arial';
            ctx.fillText(new Date().toLocaleString('it-IT'), 20, 80);
            
            // Disegna una firma stilizzata
            ctx.beginPath();
            ctx.moveTo(20, 120);
            ctx.quadraticCurveTo(100, 100, 180, 120);
            ctx.quadraticCurveTo(260, 140, 340, 120);
            ctx.stroke();
            
            addResult('info', '‚úçÔ∏è Firma test generata');
        });

        // Funzione helper per risultati
        function addResult(type, message, data = null) {
            const container = document.getElementById('resultContainer');
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-800' : 
                                             type === 'error' ? 'bg-red-50 text-red-800' : 
                                             'bg-blue-50 text-blue-800'}`;
            
            const timestamp = new Date().toLocaleTimeString('it-IT');
            let content = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (data) {
                content += `<br><code class="text-xs">${JSON.stringify(data, null, 2)}</code>`;
            }
            
            div.innerHTML = content;
            container.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Funzione per raccogliere dati form
        function getFormData() {
            return {
                mud: document.getElementById('mudInput').value,
                user: document.getElementById('userInput').value,
                luogo: document.getElementById('luogoInput').value,
                riferimento: document.getElementById('riferimentoInput').value,
                dataInizio: document.getElementById('dataInizioInput').value,
                dataFine: document.getElementById('dataFineInput').value,
                descrizione: document.getElementById('descrizioneInput').value,
                materiali: document.getElementById('materialiInput').value
            };
        }

        // Test connessione
        document.getElementById('testBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testBtn');
            const result = document.getElementById('testResult');
            
            btn.disabled = true;
            btn.textContent = 'Testing...';
            result.className = 'mt-3 p-3 rounded-lg';
            result.classList.remove('hidden');
            
            try {
                const response = await smirtSignatures.testConnection();
                result.className += ' bg-green-50 text-green-800';
                result.innerHTML = `<strong>‚úÖ Connessione OK!</strong><br><code>${JSON.stringify(response, null, 2)}</code>`;
                addResult('success', 'Test connessione riuscito', response);
            } catch (error) {
                result.className += ' bg-red-50 text-red-800';
                result.innerHTML = `<strong>‚ùå Errore:</strong> ${error.message}`;
                addResult('error', 'Test connessione fallito: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Google Apps Script';
            }
        });

        // Salva solo dati
        document.getElementById('saveDataBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveDataBtn');
            btn.disabled = true;
            btn.textContent = 'Salvando...';
            
            try {
                const data = getFormData();
                const result = await smirtSignatures.saveReportData(data);
                addResult('success', 'Dati salvati con successo', result);
            } catch (error) {
                addResult('error', 'Errore salvataggio: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '1. Salva Solo Dati';
            }
        });

        // Upload solo firma
        document.getElementById('uploadSignatureBtn').addEventListener('click', async () => {
            const btn = document.getElementById('uploadSignatureBtn');
            btn.disabled = true;
            btn.textContent = 'Caricando...';
            
            try {
                const mud = document.getElementById('mudInput').value;
                const signatureBase64 = smirtSignatures.canvasToBase64(canvas);
                
                if (!mud) throw new Error('MUD richiesto');
                if (signatureBase64.length < 100) throw new Error('Disegna prima una firma');
                
                const result = await smirtSignatures.uploadSignature(mud, 'committente', signatureBase64);
                addResult('success', 'Firma caricata con successo', result);
            } catch (error) {
                addResult('error', 'Errore upload firma: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '2. Upload Solo Firma';
            }
        });

        // Workflow completo
        document.getElementById('completeWorkflowBtn').addEventListener('click', async () => {
            const btn = document.getElementById('completeWorkflowBtn');
            btn.disabled = true;
            btn.textContent = 'Elaborando...';
            
            try {
                const data = getFormData();
                const signatureBase64 = smirtSignatures.canvasToBase64(canvas);
                
                if (signatureBase64.length < 100) {
                    throw new Error('Disegna prima una firma o usa "Genera Firma Test"');
                }
                
                const result = await smirtSignatures.saveReportWithSignature(data, canvas, 'committente');
                addResult('success', 'Workflow completo completato!', result);
            } catch (error) {
                addResult('error', 'Errore workflow: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '3. Workflow Completo';
            }
        });

        // Pulizia cartelle
        document.getElementById('cleanupBtn').addEventListener('click', async () => {
            const btn = document.getElementById('cleanupBtn');
            btn.disabled = true;
            btn.textContent = 'Pulendo...';
            
            try {
                const result = await smirtSignatures.forceCleanupFolders();
                addResult('success', 'Pulizia cartelle completata', result);
            } catch (error) {
                addResult('error', 'Errore pulizia: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üßπ Pulizia Cartelle';
            }
        });

        // Log iniziale
        addResult('info', 'Pagina di test caricata. Verifica prima la connessione.');
    </script>
</body>
</html>